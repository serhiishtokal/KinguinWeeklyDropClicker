// ==UserScript==
// @name         Kinguin Kings Drop
// @namespace    https://github.com/user/kinguin-kings-drop
// @version      1.0.1
// @description  Automates weekly Kinguin King's Drop subscription workflow
// @author       Anonymous
// @match        *://www.kinguin.net/new-checkout/review*
// @match        *://www.kinguin.net/category/*
// @match        *://www.kinguin.net/app/dashboard/subscription*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=kinguin.net
// @updateURL    https://github.com/serhiishtokal/KinguinWeeklyDropClicker/raw/refs/heads/main/dist/kinguin-kings-drop.user.js
// @downloadURL  https://github.com/serhiishtokal/KinguinWeeklyDropClicker/raw/refs/heads/main/dist/kinguin-kings-drop.user.js
// @grant        none
// @run-at       document-idle
// ==/UserScript==
!function(){"use strict";const PageType_CHECKOUT="checkout",PageType_GAME_PAGE="game-page",PageType_DASHBOARD="dashboard",PageType_UNKNOWN="unknown",ROUTE_PATTERNS=[{type:PageType_CHECKOUT,pattern:/^https?:\/\/(www\.)?kinguin\.net\/new-checkout\/review/i,description:"Checkout review page"},{type:PageType_DASHBOARD,pattern:/^https?:\/\/(www\.)?kinguin\.net\/app\/dashboard\/subscription/i,description:"Dashboard subscription page"},{type:PageType_GAME_PAGE,pattern:/^https?:\/\/(www\.)?kinguin\.net\/category\/\d+\/.+/i,description:"Game product page"}];function log(...args){console.log("[KingsDrop]",...args)}function $(selector,parent=document){return parent.querySelector(selector)}function $x(xpath,parent=document){return document.evaluate(xpath,parent,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}function isVisible(element){return!!element&&(null!==element.offsetParent||"none"!==getComputedStyle(element).display)}function injectStyles(css,id="kings-drop-styles"){const existing=document.getElementById(id);if(existing)return existing.textContent=css,existing;const style=document.createElement("style");return style.id=id,style.textContent=css,document.head.appendChild(style),style}function createOverlay(text,options={}){const{position:position="bottom-right",backgroundColor:backgroundColor="rgba(0, 0, 0, 0.85)",color:color="#fff",autoRemove:autoRemove=0}=options,existing=document.getElementById("kings-drop-overlay");existing&&existing.remove();const overlay=document.createElement("div");overlay.id="kings-drop-overlay",overlay.textContent=text;return Object.assign(overlay.style,{position:"fixed",padding:"12px 18px",borderRadius:"8px",backgroundColor:backgroundColor,color:color,fontFamily:"Arial, sans-serif",fontSize:"14px",fontWeight:"bold",zIndex:"999999",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",...{"bottom-right":{bottom:"20px",right:"20px"},"bottom-left":{bottom:"20px",left:"20px"},"top-right":{top:"20px",right:"20px"},"top-left":{top:"20px",left:"20px"}}[position]}),document.body.appendChild(overlay),autoRemove>0&&setTimeout(()=>overlay.remove(),autoRemove),overlay}function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms))}function humanDelay(min=50,max=150){return sleep(function(min=50,max=150){return Math.floor(Math.random()*(max-min+1))+min}(min,max))}function humanLikeClick(element){if(!element)return!1;const rect=element.getBoundingClientRect(),centerX=rect.left+rect.width/2,centerY=rect.top+rect.height/2,eventOptions={bubbles:!0,cancelable:!0,view:window,clientX:centerX,clientY:centerY};return element.dispatchEvent(new MouseEvent("mouseover",eventOptions)),element.dispatchEvent(new MouseEvent("mousedown",eventOptions)),element.dispatchEvent(new MouseEvent("mouseup",eventOptions)),element.dispatchEvent(new MouseEvent("click",eventOptions)),element.focus&&element.focus(),!0}const SELECTORS$2_BALANCE_INPUT="#kinguin-balance-value",SELECTORS$2_PAY_BUTTON="#kps__pay-btn";async function setMaxValueForKinguinBalance(value="999"){const input=$(SELECTORS$2_BALANCE_INPUT);if(!input)return log("setMaxValueForKinguinBalance: input not found",SELECTORS$2_BALANCE_INPUT),!1;humanLikeClick(input),await humanDelay(50,100),input.setSelectionRange(0,input.value.length),input.value="",input.dispatchEvent(new Event("input",{bubbles:!0})),await humanDelay(50,100);const typed=await async function(element,text,minDelay=50,maxDelay=150){if(!element)return!1;element.focus(),element.value="";for(const char of text)element.value+=char,element.dispatchEvent(new Event("input",{bubbles:!0})),await humanDelay(minDelay,maxDelay);return element.dispatchEvent(new Event("change",{bubbles:!0})),!0}(input,value,25,75);return input.dispatchEvent(new Event("change",{bubbles:!0})),input.blur(),log(`setMaxValueForKinguinBalance: set value to ${value}`),typed}async function setAndPay(value="999",options={}){const{preDelay:preDelay=1e3,timeout:timeout=5e3,shouldClick:shouldClick=!1}=options;if(!await setMaxValueForKinguinBalance(String(value)))return log("setAndPay: failed to set balance value"),!1;await sleep(preDelay);const button=await function(selector,options={}){const{timeout:timeout=1e4,visible:visible=!0,parent:parent=document}=options;return new Promise(resolve=>{const existing=parent.querySelector(selector);if(existing&&(!visible||isVisible(existing)))return resolve(existing);const observer=new MutationObserver((mutations,obs)=>{const el=parent.querySelector(selector);!el||visible&&!isVisible(el)||(obs.disconnect(),resolve(el))});observer.observe(parent===document?document.body:parent,{childList:!0,subtree:!0,attributes:visible}),setTimeout(()=>{observer.disconnect();const el=parent.querySelector(selector);resolve(!el||visible&&!isVisible(el)?null:el)},timeout)})}(SELECTORS$2_PAY_BUTTON,{timeout:timeout});return button?shouldClick?await async function(){const button=$(SELECTORS$2_PAY_BUTTON);return button?(humanLikeClick(button),log("clickPayButton: clicked pay button"),!0):(log("clickPayButton: pay button not found",SELECTORS$2_PAY_BUTTON),!1)}():function(){const button=$(SELECTORS$2_PAY_BUTTON);return button?(injectStyles("\n  @keyframes kinguin-pay-pulse {\n    0%, 100% {\n      box-shadow: 0 0 15px 5px rgba(255, 0, 0, 0.7),\n                  0 0 30px 10px rgba(255, 255, 0, 0.5),\n                  inset 0 0 10px rgba(255, 255, 0, 0.3);\n      transform: scale(1);\n    }\n    50% {\n      box-shadow: 0 0 25px 10px rgba(255, 0, 0, 0.9),\n                  0 0 50px 20px rgba(255, 255, 0, 0.7),\n                  inset 0 0 20px rgba(255, 255, 0, 0.5);\n      transform: scale(1.02);\n    }\n  }\n","kinguin-pay-pulse-animation"),Object.assign(button.style,{transition:"all 0.3s ease",backgroundColor:"#ff3333",background:"linear-gradient(135deg, #ff4444 0%, #cc0000 50%, #ff4444 100%)",border:"4px solid #ffff00",borderRadius:"8px",outline:"3px solid #ff0000",outlineOffset:"2px",color:"white",fontWeight:"bold",textShadow:"0 0 5px #000, 0 0 10px #ff0",animation:"kinguin-pay-pulse 1s ease-in-out infinite",position:"relative",zIndex:"9999"}),log("Pay button highlighted with enhanced visibility"),!0):(log("highlightPayButton: pay button not found",SELECTORS$2_PAY_BUTTON),!1)}():(log("setAndPay: pay button did not appear",{timeout:timeout}),!1)}const SELECTORS$1_KINGUIN_PASS_PRICE_XPATH='//*[@id="main-offer-wrapper"]/div[1]/button',SELECTORS$1_ADD_TO_CART_XPATH='//*[@id="main-offer-wrapper"]/div[2]/div/div/div/button',SELECTORS$1_ADD_TO_CART_CSS='button[data-cy="standardCheckout"]';async function clickAddToCart(){let el=$(SELECTORS$1_ADD_TO_CART_CSS);if(el||(el=$x(SELECTORS$1_ADD_TO_CART_XPATH)),!el)return log("clickAddToCart: Add to Cart button not found",{selector:SELECTORS$1_ADD_TO_CART_CSS,xpath:SELECTORS$1_ADD_TO_CART_XPATH}),!1;if((el.textContent||el.innerText||"").toUpperCase().includes("SUBSCRIBE AND ADD TO CART")){log('clickAddToCart: GLITCH DETECTED - Button shows "SUBSCRIBE AND ADD TO CART"');const parentContainer=el.closest("div")||el.parentElement;return function(button,parentContainer){Object.assign(button.style,{border:"3px solid red",backgroundColor:"rgba(255, 0, 0, 0.3)",boxShadow:"0 0 10px red"});const warningMessage=document.createElement("div");warningMessage.textContent="refresh the page!!!",warningMessage.id="kinguin-glitch-warning",Object.assign(warningMessage.style,{color:"red",fontWeight:"bold",fontSize:"16px",padding:"10px",marginTop:"10px",backgroundColor:"#ffeeee",border:"2px solid red",borderRadius:"4px",textAlign:"center",animation:"kinguin-glitch-blink 1s infinite"}),injectStyles("\n  @keyframes kinguin-glitch-blink {\n    0%, 50% { opacity: 1; }\n    51%, 100% { opacity: 0.5; }\n  }\n","kinguin-glitch-style"),parentContainer?parentContainer.insertAdjacentElement("afterend",warningMessage):button.insertAdjacentElement("afterend",warningMessage)}(el,parentContainer),createOverlay("⚠️ GLITCH DETECTED - Refresh the page!",{backgroundColor:"rgba(244, 67, 54, 0.95)",autoRemove:0}),!1}return humanLikeClick(el),log("clickAddToCart: clicked Add to Cart button"),!0}async function selectKinguinPassAndAddToCart(options={}){const{waitTimeout:waitTimeout=2e3,pollInterval:pollInterval=50,betweenClicksDelay:betweenClicksDelay={min:100,max:400}}=options;if(!await async function(){const el=$x(SELECTORS$1_KINGUIN_PASS_PRICE_XPATH);return el?(humanLikeClick(el),log("clickKinguinPassPrice: clicked KinguinPass price option"),!0):(log("clickKinguinPassPrice: KinguinPass price option not found",SELECTORS$1_KINGUIN_PASS_PRICE_XPATH),!1)}())return log("selectKinguinPassAndAddToCart: failed to click KinguinPass price option"),!1;log("selectKinguinPassAndAddToCart: waiting for element to be enabled");await async function(xpath,timeout=5e3,interval=50){const start=Date.now();for(;Date.now()-start<timeout;){const el=$x(xpath);if(el&&null!==el.offsetParent&&!el.disabled&&!el.classList.contains("disabled"))return el;await sleep(interval)}return null}(SELECTORS$1_KINGUIN_PASS_PRICE_XPATH,waitTimeout,pollInterval)||log("selectKinguinPassAndAddToCart: KinguinPass price option did not become enabled",{xpath:SELECTORS$1_KINGUIN_PASS_PRICE_XPATH,timeout:waitTimeout}),await humanDelay(betweenClicksDelay.min,betweenClicksDelay.max);return await clickAddToCart()?(log("selectKinguinPassAndAddToCart: completed successfully"),!0):(log("selectKinguinPassAndAddToCart: failed to click Add to Cart button"),!1)}const SELECTORS_SUBSCRIPTION_SECTION_XPATH='//*[@id="c-page__content"]/div/div[2]/div/div/div/div[1]/section';async function scrollToSubscriptionSection(){const xpath=SELECTORS_SUBSCRIPTION_SECTION_XPATH;log("scrollToSubscriptionSection: waiting for element...",xpath);const el=await function(xpath,options={}){const{timeout:timeout=1e4,pollInterval:pollInterval=200,visible:visible=!0,parent:parent=document}=options;return new Promise(resolve=>{const startTime=Date.now(),check=()=>{const el=document.evaluate(xpath,parent,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;!el||visible&&!isVisible(el)?Date.now()-startTime>=timeout?resolve(null):setTimeout(check,pollInterval):resolve(el)};check()})}(xpath,{timeout:1e4,pollInterval:200});return el?(el.scrollIntoView({behavior:"auto",block:"center"}),log("Scrolled to subscription section"),el):(log("scrollToSubscriptionSection: element not found after timeout",xpath),null)}async function clickGetNowButton(sectionElement){if(!sectionElement)return log("clickGetNowButton: section element is null"),!1;const buttons=function(selector,parent=document){return Array.from(parent.querySelectorAll(selector))}("button",sectionElement);let getButton=null;for(const button of buttons)if(button.textContent&&button.textContent.includes("Get Now")){getButton=button;break}return getButton?(log('Found "Get Now" button'),humanLikeClick(getButton),log('Clicked "Get Now" button successfully'),!0):(log('clickGetNowButton: "Get Now" button not found in section'),!1)}const PAGE_HANDLERS={[PageType_CHECKOUT]:async function(){log("Initializing checkout page handler..."),createOverlay("KinguinClicker: Checkout - Automating...",{backgroundColor:"rgba(76, 175, 80, 0.9)",autoRemove:2e3}),await sleep(500);const success=await setAndPay("999",{shouldClick:!1});return success?createOverlay("KinguinClicker: Ready to Pay!",{backgroundColor:"rgba(76, 175, 80, 0.9)",autoRemove:3e3}):createOverlay("KinguinClicker: Could not find checkout elements",{backgroundColor:"rgba(244, 67, 54, 0.9)",autoRemove:5e3}),success},[PageType_GAME_PAGE]:async function(){log("Initializing game page handler..."),createOverlay("KinguinClicker: Game Page - Automating...",{backgroundColor:"rgba(76, 175, 80, 0.9)",autoRemove:2e3}),await sleep(500);const success=await selectKinguinPassAndAddToCart();if(success)createOverlay("KinguinClicker: Added to Cart!",{backgroundColor:"rgba(76, 175, 80, 0.9)",autoRemove:3e3});else{document.getElementById("kinguin-glitch-warning")||createOverlay("KinguinClicker: Could not complete game page automation",{backgroundColor:"rgba(244, 67, 54, 0.9)",autoRemove:5e3})}return success},[PageType_DASHBOARD]:async function(){log("Initializing dashboard page handler..."),createOverlay("KinguinClicker: Dashboard - Automating...",{position:"top-left",backgroundColor:"rgba(76, 175, 80, 0.9)",autoRemove:2e3}),await sleep(500);const success=await async function(){const section=await scrollToSubscriptionSection();return section?(await humanDelay(200,400),await clickGetNowButton(section)?(log("scrollAndClickGetNow: completed successfully"),!0):(log("scrollAndClickGetNow: failed to click Get Now button"),!1)):(log("scrollAndClickGetNow: failed to find subscription section"),!1)}();return success?createOverlay("KinguinClicker: Subscription Activated!",{position:"top-left",backgroundColor:"rgba(76, 175, 80, 0.9)",autoRemove:3e3}):createOverlay("KinguinClicker: Could not find subscription elements",{position:"top-left",backgroundColor:"rgba(244, 67, 54, 0.9)",autoRemove:5e3}),success}};function init(){const url=window.location.href,pageType=function(url){for(const route of ROUTE_PATTERNS)if(route.pattern.test(url))return route.type;return PageType_UNKNOWN}(url),routeDescription=function(url){for(const route of ROUTE_PATTERNS)if(route.pattern.test(url))return route.description;return"Unknown page"}(url);log(`Page detected: ${pageType} (${routeDescription})`),log(`URL: ${url}`);const handler=PAGE_HANDLERS[pageType];if(handler){log(`Initializing ${pageType} handler...`);try{handler(),log(`${pageType} handler initialized successfully`)}catch(error){log(`Error initializing ${pageType} handler:`,error),createOverlay(`Error: ${error.message}`,{backgroundColor:"rgba(244, 67, 54, 0.9)",autoRemove:5e3})}}else log(`No handler registered for page type: ${pageType}`),pageType!==PageType_UNKNOWN&&createOverlay(`KingsDrop: ${routeDescription} (handler pending)`,{backgroundColor:"rgba(33, 150, 243, 0.9)",autoRemove:3e3})}log("Script loaded, bootstrapping..."),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()}();
